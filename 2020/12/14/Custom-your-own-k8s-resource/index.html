
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Weyoung&#39;s Blog">
    <title>如何自定义Kubernetes资源 - Weyoung&#39;s Blog</title>
    <meta name="author" content="Prince Chen">
    
    
        <link rel="icon" href="http://talentprince.github.io/assets/images/favicon.ico">
    
    
        
            <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Prince Chen","sameAs":["https://github.com/talentprince","mailto"],"image":"https://www.gravatar.com/avatar/ff771efeac20ab47f827e759b38f6d53"},"articleBody":"目前最流行的微服务架构非Springboot+Kubernetes+Istio莫属, 然而随着越来越多的微服务被拆分出来, 不但Deploy过程boilerplate的配置越来越多, 且繁琐易错, 维护成本也逐渐增高, 那么是时候采用k8s提供的扩展自定义资源的方法, 将重复的template抽到后面, 从而简化Deploy配置的数量与复杂度.\n\nTips:一个基础的k8s微服务应该由几部分组成, 首先Deployment负责App的部署, Service负责端口的暴露, ServiceAccount负责赋予Pod相应的Identity, ServiceRole+RoleBinding负责api的访问权限控制, VirtualService负责路由\n如果我们通过自定义资源的方式, 将每个微服务App的共有配置封装起来, 暴露出可变部分供各个应用配置, 如image, public/private api, mesh内访问权限等, 并设置mandatory/required的字段与validation pattern, 这样每一个App只需要一个配置文件, 就可以完成统一部署.\n下面我们可以首先看一下k8s提供的扩展的两种方法.\n\n通过Aggregated Apiserver\n通过Custom Resource Defination\n\n\n这两种最大的区别就是, 前者需要自己实现一个用户自定义的Apiserver, 而后者是被kube-apiserver内的extension apiserver module所处理.\n二者都需要通过自定义Controller来处理资源的配置.\n创建CRD虽然看似AA的开放程度更高, 但实际上通过CRD来定义自定义资源更成熟且方便. 通过官方文档, 我们可以看到CRD的定义规则, 如下面我们定义的一个资源Beer:\n1234567891011121314151617181920212223242526272829303132apiVersion: apiextensions.k8s.io/v1kind: CustomResourceDefinitionmetadata:  name: beer.weyoung.iospec:  group: weyoung.io  versions:     - name: v1alpha1      storage: true      served: true      schema:           openAPIV3Schema:             type: object            properties:              spec:                type: object                properties:                  BeerName:                    description: This is a custom field of beer                          pattern: ^[a-z]+$                    type: string                required:                 - beerName            required:             - spec            type: object  names:    kind: Beer     listKind: BeerList    singular: beer    plural: beers  scope: Namespaced\n这里我们添加了一个自定义字段beerName, 指定了pattern, 并且设置了spec与其下的beerName死required字段. 其余关键字可以查阅官方文档.\n在apply该配置后, 通过kubectl get crd即可获得已经存在的资源.\n123   kubectl get crdNAME                   CREATED ATbeers.weyoung.io   2020-12-12T17:28:34Z\n有了CRD之后, 我们就可以apply自定义的资源了:\n123456apiVersion: weyoung.io/v1alpha1kind: Beermetadata:  name: test-beerspec:  beerName: abc\n这里大家可以试验一下required与pattern的作用是否生效.\n这里有个比较关键的点, CRD中未声明的资源依旧可以被成功添加到Beer资源里, 并成功apply&amp;configured, 但是不具备validation的效果, 这也可能是早期版本的crd把schema关键字换做validation的原因吧.\n创建Controller当我们实现了自己的CRD, 并且apply了根据CRD定义的自定义资源Beer后, 这仅仅是存在etcd的静态资源, 还需要controller来根据Beer的变化创建相应资源, 让Beer动起来.\n首先可以先了解一下Controller的工作原理.\n\n从图中可以看出, Informer模块内的Reflactor会监听k8sapi, 根据自己注册的资源类型, 轮询的将所有资源的最新状态存入队列, Indexer会对资源进行index, 生成key与namespace/name的映射关系. \n通过Informer的监听方法, 可以从队列依次读取, 放进WorkQueue中供controller消费, 而controller可以通过Lister API由namespace/name获取到对应的自定义资源, 并做增删改查操作.\n看似有很多模块在其中, 不过k8s已经帮我们实现了大部分(Informer, Lister等), 即它的client-go library. 我们只需要用对应的api来实现自己的controller部分就可以了.\n具体的逻辑, k8s官方提供了一个sample-controller来供大家学习, 本人通过对这个sample的踩坑, 总结了一些需要注意的地方会在之后highlight出来.\n总体来讲, 自定义自己的controller需要三个步骤:\n\n定义资源Type与注册\n生成Informer相应代码\n编写与调用Controller\n\n当然在这之前, 需要先添加依赖.\n\napimachinery 负责client与k8sapi之间通信编解码等\nclient-go 调用k8s cluster相关api\ncode-generator 根据定义的type生成相关代码, 包括informer, client\n这里需要注意的是依赖版本应该最新, 并且一致, 因为在尝试多次之后, 发现新老版本之间的变化非常大, 添加了很多新的module与功能, 而且如果不一致, 也会导致代码生成, 与k8sapi之间通信等各种的异常.\n当我们通过go init custom-k8s-controller初始化新的module后, 可以添加最新依赖:\n123go get apimachinery@mastergo get client-go@mastergo get code-generator@master\n\n\n定义Type与注册首先需要在工程目录创建一个存放自己api module的地方, 如api, 并在之下创建beercontroller, 放置我们自定义资源相关的代码, 版本号可以自己定义, v1/v1alphav1.\n\ntypes.go\n\n123456789101112131415161718192021222324252627282930package v1alpha1import (\tmetav1 &quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;)// +genclient// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object//Beer is a custom kubenetes resourectype Beer struct &#123;\tmetav1.TypeMeta   `json:&quot;,inline&quot;`\tmetav1.ObjectMeta `json:&quot;metadata,omitempty&quot;`\tSpec              BeerSpec `json:&quot;spec&quot;`&#125;//BeerSpec is the spec of Beertype BeerSpec struct &#123;\tBeerName string `json:&quot;BeerName&quot;`&#125;// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object//BeerList is a list of Beertype BeerList struct &#123;\tmetav1.TypeMeta `json:&quot;,inline&quot;`\tmetav1.ListMeta `json:&quot;metadata&quot;`\tItems []Beer `json:&quot;items&quot;`&#125;\n这里定义了Beer的成员BeerName, 且有两行给代码生成器的注释也很关键, 不能缺失.\n\nregister.go\n\n1234567891011121314151617181920...var (\t// SchemeBuilder initializes a scheme builder\tSchemeBuilder = runtime.NewSchemeBuilder(addKnownTypes)\t// AddToScheme is a global function that registers this API group &amp; version to a scheme\tAddToScheme = SchemeBuilder.AddToScheme)func addKnownTypes(scheme *runtime.Scheme) error &#123;\tscheme.AddKnownTypes(\t\tSchemeGroupVersion,\t\t&amp;Beer&#123;&#125;,\t\t&amp;BeerList&#123;&#125;,\t)\t// register the type in the scheme\tmetav1.AddToGroupVersion(scheme, SchemeGroupVersion)\treturn nil&#125;...\n这里省略了一些, 完整代码可参考官方sample. 这里主要的逻辑是将我们定义的资源注册上去, 当然由于还没有运行generator, AddKnownTypes会因为我们的Beer没有Deepcopy而报错.\n生成代码之前讲过需要实现一个完整的自定义k8s资源需要很多东西, 但实际上除了controller之外的都可以生成出来, 这里就使用到了code-generator里面的generate-groups.sh.\n由于要使用该脚本, 这里我们可以添加vendor来管理我们的之前添加的依赖. 在工程的根目录输出git mod vendor来创建vendor目录, 这时所有之前添加过的依赖 (go.mod)都会出现在这个文件夹下供我们项目使用.\n关于如何调用generator的逻辑可以参考官方sample, 这里我们需要给vendor整体(-R)赋予可执行权限, 否则在generate的过程会提示权限问题.\n关于generate-groups.sh的使用需要注意的是它其中的2,3,4参数, 分别为输出目录, 输入目录(我们自定义资源的module所在的目录, 即之前创建的api文件夹), 自定义资源名:版本.\n具体参数设置也可以参考:\n1234567../vendor/k8s.io/code-generator/generate-groups.sh \\  &quot;deepcopy,client,informer,lister&quot; \\  custom-k8s-controller/generated \\  custom-k8s-controller/api \\  beercontroller:v1alpha1 \\  --go-header-file $(pwd)/boilerplate.go.txt \\  --output-base $(pwd)/../../\n在执行脚本过后, 它会在types.go旁生成deepcopy代码, 并会在我们指定的generated文件夹下生成informer, lister等代码.\n编写与调用Controller现在万事俱备只欠实现最后的自定义资源处理逻辑, 就是之前提到的controller.\n首先我们需要定义controller的成员:\n123456789101112131415161718192021type Controller struct &#123;\t// kubeclientset is a standard kubernetes clientset\tkubeclientset kubernetes.Interface\t// beerclientset is a clientset for our own API group\tbeerclientset clientset.Interface\tdeploymentsLister appslisters.DeploymentLister\tdeploymentsSynced cache.InformerSynced\tbeersLister   listers.beerLister\tbeersSynced   cache.InformerSynced\t// workqueue is a rate limited work queue. This is used to queue work to be\t// processed instead of performing it as soon as a change happens. This\t// means we can ensure we only process a fixed amount of resources at a\t// time, and makes it easy to ensure we are never processing the same item\t// simultaneously in two different workers.\tworkqueue workqueue.RateLimitingInterface\t// recorder is an event recorder for recording Event resources to the\t// Kubernetes API.\trecorder record.EventRecorder&#125;\n其中kubeclientset可以调用k8s的CRUD api, 例如创建更新deployment; beerclientset可以调用自定义资源的CRUD; deploymentsLister与beersLister可以通过namespace/name获得对应资源; workqueue用来同步与限流多个自定义资源处理worker; recorder用来publish在资源处理过程中的事件, 该事件可以在kubectl describe里面看到.\n接着我们可以创建构造函数将clientset, informer传入构建自己的controller对象, 并通过informer的AddEventHandler添加监听, 将回调的beer资源通过indexer(cache)的MetaNamespaceKeyFunc方法转换为key, 加入workqueue队列.\n当然有队列必然有死循环去读取这个队列, 这也是我们启动整个controller的入口, 我们需要从workqueue中pop交由下游处理, 在处理成功后调用forget方法清除queue, 否则会重新进行处理.\n处理资源是我们controller的核心逻辑, 这里我们可以再次通过indexer(cache)通过key反转回namespace/name, 然后通过listers查找对应的资源, 比如beer或者deployment, 通过对比自定义资源与背后k8s资源的区别, 对k8s资源进行CRUD.\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051func (c *Controller) syncHandler(key string) error &#123;\t// Convert the namespace/name string into a distinct namespace and name\tnamespace, name, err := cache.SplitMetaNamespaceKey(key)\tif err != nil &#123;\t\tutilruntime.HandleError(fmt.Errorf(&quot;invalid resource key: %s&quot;, key))\t\treturn nil\t&#125;\t// Get the beer resource with this namespace/name\tbeer, err := c.beersLister.beers(namespace).Get(name)\tif err != nil &#123;\t\t// The beer resource may no longer exist, in which case we stop\t\t// processing.\t\tklog.Infof(&quot;beer %s is deleted &quot;, name)\t\tif errors.IsNotFound(err) &#123;\t\t\tutilruntime.HandleError(fmt.Errorf(&quot;beer &apos;%s&apos; in work queue no longer exists&quot;, key))\t\t\treturn nil\t\t&#125;\t\treturn err\t&#125;\tdeploymentName := beer.Spec.beerName\tif deploymentName == &quot;&quot; &#123;\t\t// We choose to absorb the error here as the worker would requeue the\t\t// resource otherwise. Instead, the next time the resource is updated\t\t// the resource will be queued again.\t\tutilruntime.HandleError(fmt.Errorf(&quot;%s: deployment name must be specified&quot;, key))\t\treturn nil\t&#125;\tdeployment, err := c.deploymentsLister.Deployments(beer.Namespace).Get(beer.Name)\t// If the resource doesn&apos;t exist, we&apos;ll create it\tif errors.IsNotFound(err) &#123;\t\tdeployment, err = c.kubeclientset.AppsV1().Deployments(beer.Namespace).Create(context.TODO(), newDeployment(beer), metav1.CreateOptions&#123;&#125;)\t&#125;\t// If an error occurs during Get/Create, we&apos;ll requeue the item so we can\t// attempt processing again later. This could have been caused by a\t// temporary network failure, or any other transient reason.\tif err != nil &#123;\t\treturn err\t&#125;  // ***********************  // Handle custom CRUD here  // ***********************\tc.recorder.Event(beer, corev1.EventTypeNormal, SuccessSynced, MessageResourceSynced)\treturn nil&#125;\n整个syncHanlder函数分为四个部分:\n\n通过index做key-&gt;namespace/name\n通过lister查找beer资源\n如果不存在, 说明这是一次删除操作, 直接返回\n\n\n通过lister获取deployment\n如果不存在, 通过beer中相关字段创建对应的deployment, 或者其他k8s资源\n\n\n否则, 说明资源已经存在, 则对比beer与实际资源的区别, 判断是否需要对相应的资源, 如deployment进行更新. 这里举例子\n\n当然在整个过程中也可以通过recorder来广播event, 这样在apply自定义资源后, 可以获取一定信息, 方便查看或者debug问题原因.\ncontroller完整的逻辑存在大量boilerplate的代码, 具体也可以参考官方的sample进行学习.\n最后还有一点需要注意的是, 在我们创建并启动自己的controller时, 即本次custom-k8s-controller的入口main package内, 除了调用构造以及启动函数, 一定要记得传入的Informer需要调用Start进行启动, 否则无法获得资源变化的回调. 当然这里也涉及到需要传入一个stopSignal可以让监听中断, 这一个可以直接copy官方代码.\n总结k8s已经提供了一个非常详尽的demo来实现自定义资源并通过controller进行配置, 但是对于没有go开发经验, 有不少由于版本, 依赖, 权限造成的小问题, 希望文章中highlight的点能提供一定帮助~\n最后通过不懈努力, 我们可以通过一个自定义的Beer资源来deploy pod了. 由于这条路的打通, 我们可以继续添加CRD的schema, 并在controller内进行解析, 简化deploy过程, 统一基于k8s的微服务基础架构. 比如对于任意一个通过Beer资源deploy的app, 我们都通过istio sidecar来做ingress/outgress, 对于image的完整仓库地址, 我们也在后面通过不同部署(apply)环境来组合不同的地址, 还有大量缺省值的公共配置, 都不需要再重复的写在多个yaml中了.\nReference\nhttps://github.com/kubernetes/sample-controller\nhttps://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/\nhttps://itnext.io/comparing-kubernetes-api-extension-mechanisms-of-custom-resource-definition-and-aggregated-api-64f4ca6d0966\n\n","dateCreated":"2020-12-14T11:20:20+08:00","dateModified":"2020-12-16T08:48:14+08:00","datePublished":"2020-12-14T11:20:20+08:00","description":"目前最流行的微服务架构非Springboot+Kubernetes+Istio莫属, 然而随着越来越多的微服务被拆分出来, 不但Deploy过程boilerplate的配置越来越多, 且繁琐易错, 维护成本也逐渐增高, 那么是时候采用k8s提供的扩展自定义资源的方法, 将重复的template抽到后面, 从而简化Deploy配置的数量与复杂度.","headline":"如何自定义Kubernetes资源","image":["https://res.cloudinary.com/dtn0pkdmg/image/upload/v1608028893/beer_koqjxh.jpg"],"mainEntityOfPage":{"@type":"WebPage","@id":"http://talentprince.github.io/2020/12/14/Custom-your-own-k8s-resource/"},"publisher":{"@type":"Organization","name":"Prince Chen","sameAs":["https://github.com/talentprince","mailto"],"image":"https://www.gravatar.com/avatar/ff771efeac20ab47f827e759b38f6d53","logo":{"@type":"ImageObject","url":"https://www.gravatar.com/avatar/ff771efeac20ab47f827e759b38f6d53"}},"url":"http://talentprince.github.io/2020/12/14/Custom-your-own-k8s-resource/","keywords":"Kubernetes, Istio","thumbnailUrl":"https://res.cloudinary.com/dtn0pkdmg/image/upload/v1608028893/beer_koqjxh.jpg"}</script>
    <meta name="description" content="通过自定义Kubernetes资源来降低微服务开发与维护成本, CustomResourceDefinition">
<meta name="keywords" content="Kubernetes,Istio">
<meta property="og:type" content="blog">
<meta property="og:title" content="如何自定义Kubernetes资源">
<meta property="og:url" content="http://talentprince.github.io/2020/12/14/Custom-your-own-k8s-resource/index.html">
<meta property="og:site_name" content="Weyoung&#39;s Blog">
<meta property="og:description" content="通过自定义Kubernetes资源来降低微服务开发与维护成本, CustomResourceDefinition">
<meta property="og:locale" content="zh-cn">
<meta property="og:image" content="http://talentprince.github.io/images/k8s-extension.png">
<meta property="og:image" content="http://talentprince.github.io/images/k8s_controller.jpg">
<meta property="og:updated_time" content="2020-12-16T00:48:14.272Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="如何自定义Kubernetes资源">
<meta name="twitter:description" content="通过自定义Kubernetes资源来降低微服务开发与维护成本, CustomResourceDefinition">
<meta name="twitter:image" content="http://talentprince.github.io/images/k8s-extension.png">
    
    
        
    
    
    
        <meta property="og:image" content="https://res.cloudinary.com/dtn0pkdmg/image/upload/v1608028893/beer_koqjxh.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://res.cloudinary.com/dtn0pkdmg/image/upload/v1608028893/beer_koqjxh.jpg"/>
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-mfdqvh3ohnpramsqqbc7zbl79sacpxx7rmxse96gjjfq9veqgomv4f7jzw28.min.css">
    <!--STYLES END-->
    

    
    <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?26839bbbc9c89fbe9eb99aba7bceb413";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>


    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/ "
            aria-label=""
        >
            Weyoung&#39;s Blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="打开链接: /#about"
            >
        
        
        </a>
    
</header>

            <!-- Define author's picture -->


<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="首页"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首页</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="分类"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分类</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="标签"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">标签</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="归档"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">归档</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="搜索"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">搜索</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="关于"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">关于</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/talentprince"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/mailto"
                            
                            rel="noopener"
                            title="邮箱"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">邮箱</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="5"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            如何自定义Kubernetes资源
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2020-12-14T11:20:20+08:00">
	
		    12月 14, 2020
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/DevOps/">DevOps</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>目前最流行的微服务架构非<code>Springboot+Kubernetes+Istio</code>莫属, 然而随着越来越多的微服务被拆分出来, 不但Deploy过程boilerplate的配置越来越多, 且繁琐易错, 维护成本也逐渐增高, 那么是时候采用k8s提供的扩展自定义资源的方法, 将重复的template抽到后面, 从而简化Deploy配置的数量与复杂度.</p>
<a id="more"></a>
<p>Tips:<br><code>一个基础的k8s微服务应该由几部分组成, 首先Deployment负责App的部署, Service负责端口的暴露, ServiceAccount负责赋予Pod相应的Identity, ServiceRole+RoleBinding负责api的访问权限控制, VirtualService负责路由</code></p>
<p>如果我们通过自定义资源的方式, 将每个微服务App的共有配置封装起来, 暴露出可变部分供各个应用配置, 如image, public/private api, mesh内访问权限等, 并设置mandatory/required的字段与validation pattern, 这样每一个App只需要一个配置文件, 就可以完成统一部署.</p>
<p>下面我们可以首先看一下k8s提供的扩展的两种方法.</p>
<ul>
<li>通过Aggregated Apiserver</li>
<li>通过Custom Resource Defination</li>
</ul>
<p><img src="/images/k8s-extension.png" alt="k8s-extension"></p>
<p>这两种最大的区别就是, 前者需要自己实现一个用户自定义的Apiserver, 而后者是被kube-apiserver内的extension apiserver module所处理.</p>
<p>二者都需要通过自定义Controller来处理资源的配置.</p>
<h2 id="创建CRD"><a href="#创建CRD" class="headerlink" title="创建CRD"></a>创建CRD</h2><p>虽然看似AA的开放程度更高, 但实际上通过CRD来定义自定义资源更成熟且方便. 通过<a href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/" target="_blank" rel="noopener">官方文档</a>, 我们可以看到CRD的定义规则, 如下面我们定义的一个资源<code>Beer</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apiextensions.k8s.io/v1</span><br><span class="line">kind: CustomResourceDefinition</span><br><span class="line">metadata:</span><br><span class="line">  name: beer.weyoung.io</span><br><span class="line">spec:</span><br><span class="line">  group: weyoung.io</span><br><span class="line">  versions: </span><br><span class="line">    - name: v1alpha1</span><br><span class="line">      storage: true</span><br><span class="line">      served: true</span><br><span class="line">      schema: </span><br><span class="line">          openAPIV3Schema: </span><br><span class="line">            type: object</span><br><span class="line">            properties:</span><br><span class="line">              spec:</span><br><span class="line">                type: object</span><br><span class="line">                properties:</span><br><span class="line">                  BeerName:</span><br><span class="line">                    description: This is a custom field of beer      </span><br><span class="line">                    pattern: ^[a-z]+$</span><br><span class="line">                    type: string</span><br><span class="line">                required: </span><br><span class="line">                - beerName</span><br><span class="line">            required: </span><br><span class="line">            - spec</span><br><span class="line">            type: object</span><br><span class="line">  names:</span><br><span class="line">    kind: Beer </span><br><span class="line">    listKind: BeerList</span><br><span class="line">    singular: beer</span><br><span class="line">    plural: beers</span><br><span class="line">  scope: Namespaced</span><br></pre></td></tr></table></figure>
<p>这里我们添加了一个自定义字段<code>beerName</code>, 指定了pattern, 并且设置了spec与其下的beerName死<code>required</code>字段. 其余关键字可以查阅<a href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/" target="_blank" rel="noopener">官方文档</a>.</p>
<p>在apply该配置后, 通过<code>kubectl get crd</code>即可获得已经存在的资源.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">   kubectl get crd</span><br><span class="line">NAME                   CREATED AT</span><br><span class="line">beers.weyoung.io   2020-12-12T17:28:34Z</span><br></pre></td></tr></table></figure>
<p>有了CRD之后, 我们就可以apply自定义的资源了:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: weyoung.io/v1alpha1</span><br><span class="line">kind: Beer</span><br><span class="line">metadata:</span><br><span class="line">  name: test-beer</span><br><span class="line">spec:</span><br><span class="line">  beerName: abc</span><br></pre></td></tr></table></figure>
<p>这里大家可以试验一下required与pattern的作用是否生效.</p>
<p>这里有个比较关键的点, CRD中未声明的资源依旧可以被成功添加到<code>Beer</code>资源里, 并成功apply&amp;configured, 但是不具备validation的效果, 这也可能是早期版本的crd把<code>schema</code>关键字换做<code>validation</code>的原因吧.</p>
<h2 id="创建Controller"><a href="#创建Controller" class="headerlink" title="创建Controller"></a>创建Controller</h2><p>当我们实现了自己的CRD, 并且apply了根据CRD定义的自定义资源<code>Beer</code>后, 这仅仅是存在etcd的静态资源, 还需要controller来根据<code>Beer</code>的变化创建相应资源, 让<code>Beer</code>动起来.</p>
<p>首先可以先了解一下Controller的工作原理.</p>
<p><img src="/images/k8s_controller.jpg" alt="controller"></p>
<p>从图中可以看出, Informer模块内的Reflactor会监听k8sapi, 根据自己注册的资源类型, 轮询的将所有资源的最新状态存入队列, Indexer会对资源进行index, 生成key与namespace/name的映射关系. </p>
<p>通过Informer的监听方法, 可以从队列依次读取, 放进WorkQueue中供controller消费, 而controller可以通过Lister API由namespace/name获取到对应的自定义资源, 并做增删改查操作.</p>
<p>看似有很多模块在其中, 不过k8s已经帮我们实现了大部分(Informer, Lister等), 即它的<code>client-go</code> library. 我们只需要用对应的api来实现自己的controller部分就可以了.</p>
<p>具体的逻辑, k8s官方提供了一个<a href="https://github.com/kubernetes/sample-controller" target="_blank" rel="noopener">sample-controller</a>来供大家学习, 本人通过对这个sample的踩坑, 总结了一些需要注意的地方会在之后highlight出来.</p>
<p>总体来讲, 自定义自己的controller需要三个步骤:</p>
<ul>
<li>定义资源Type与注册</li>
<li>生成Informer相应代码</li>
<li>编写与调用Controller</li>
</ul>
<p>当然在这之前, 需要先添加依赖.</p>
<ul>
<li>apimachinery 负责client与k8sapi之间通信编解码等</li>
<li>client-go 调用k8s cluster相关api</li>
<li><p>code-generator 根据定义的type生成相关代码, 包括informer, client</p>
<p>这里需要注意的是依赖版本应该最新, 并且一致, 因为在尝试多次之后, 发现新老版本之间的变化非常大, 添加了很多新的module与功能, 而且如果不一致, 也会导致代码生成, 与k8sapi之间通信等各种的异常.</p>
<p>当我们通过<code>go init custom-k8s-controller</code>初始化新的module后, 可以添加最新依赖:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">go get apimachinery@master</span><br><span class="line">go get client-go@master</span><br><span class="line">go get code-generator@master</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="定义Type与注册"><a href="#定义Type与注册" class="headerlink" title="定义Type与注册"></a>定义Type与注册</h3><p>首先需要在工程目录创建一个存放自己api module的地方, 如<code>api</code>, 并在之下创建<code>beercontroller</code>, 放置我们自定义资源相关的代码, 版本号可以自己定义, v1/v1alphav1.</p>
<ul>
<li><code>types.go</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">package v1alpha1</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	metav1 &quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">// +genclient</span><br><span class="line">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span><br><span class="line"></span><br><span class="line">//Beer is a custom kubenetes resourec</span><br><span class="line">type Beer struct &#123;</span><br><span class="line">	metav1.TypeMeta   `json:&quot;,inline&quot;`</span><br><span class="line">	metav1.ObjectMeta `json:&quot;metadata,omitempty&quot;`</span><br><span class="line">	Spec              BeerSpec `json:&quot;spec&quot;`</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//BeerSpec is the spec of Beer</span><br><span class="line">type BeerSpec struct &#123;</span><br><span class="line">	BeerName string `json:&quot;BeerName&quot;`</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span><br><span class="line"></span><br><span class="line">//BeerList is a list of Beer</span><br><span class="line">type BeerList struct &#123;</span><br><span class="line">	metav1.TypeMeta `json:&quot;,inline&quot;`</span><br><span class="line">	metav1.ListMeta `json:&quot;metadata&quot;`</span><br><span class="line"></span><br><span class="line">	Items []Beer `json:&quot;items&quot;`</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里定义了<code>Beer</code>的成员<code>BeerName</code>, 且有两行给代码生成器的注释也很关键, 不能缺失.</p>
<ul>
<li><code>register.go</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">var (</span><br><span class="line">	// SchemeBuilder initializes a scheme builder</span><br><span class="line">	SchemeBuilder = runtime.NewSchemeBuilder(addKnownTypes)</span><br><span class="line">	// AddToScheme is a global function that registers this API group &amp; version to a scheme</span><br><span class="line">	AddToScheme = SchemeBuilder.AddToScheme</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func addKnownTypes(scheme *runtime.Scheme) error &#123;</span><br><span class="line">	scheme.AddKnownTypes(</span><br><span class="line">		SchemeGroupVersion,</span><br><span class="line">		&amp;Beer&#123;&#125;,</span><br><span class="line">		&amp;BeerList&#123;&#125;,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	// register the type in the scheme</span><br><span class="line">	metav1.AddToGroupVersion(scheme, SchemeGroupVersion)</span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>这里省略了一些, 完整代码可参考官方<a href="https://github.com/.kubernetes/sample-controller/blob/master/pkg/apis/samplecontroller/v1alpha1/register.go" target="_blank" rel="noopener">sample</a>. 这里主要的逻辑是将我们定义的资源注册上去, 当然由于还没有运行generator, AddKnownTypes会因为我们的<code>Beer</code>没有Deepcopy而报错.</p>
<h3 id="生成代码"><a href="#生成代码" class="headerlink" title="生成代码"></a>生成代码</h3><p>之前讲过需要实现一个完整的自定义k8s资源需要很多东西, 但实际上除了controller之外的都可以生成出来, 这里就使用到了<code>code-generator</code>里面的<code>generate-groups.sh</code>.</p>
<p>由于要使用该脚本, 这里我们可以添加<code>vendor</code>来管理我们的之前添加的依赖. 在工程的根目录输出<code>git mod vendor</code>来创建vendor目录, 这时所有之前添加过的依赖 (go.mod)都会出现在这个文件夹下供我们项目使用.</p>
<p>关于如何调用generator的逻辑可以参考官方<a href="https://github.com/kubernetes/code-generator/blob/master/hack/update-codegen.sh" target="_blank" rel="noopener">sample</a>, 这里我们需要给<code>vendor</code>整体(-R)赋予可执行权限, 否则在generate的过程会提示权限问题.</p>
<p>关于<code>generate-groups.sh</code>的使用需要注意的是它其中的2,3,4参数, 分别为输出目录, 输入目录(我们自定义资源的module所在的目录, 即之前创建的api文件夹), 自定义资源名:版本.</p>
<p>具体参数设置也可以参考:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">../vendor/k8s.io/code-generator/generate-groups.sh \</span><br><span class="line">  &quot;deepcopy,client,informer,lister&quot; \</span><br><span class="line">  custom-k8s-controller/generated \</span><br><span class="line">  custom-k8s-controller/api \</span><br><span class="line">  beercontroller:v1alpha1 \</span><br><span class="line">  --go-header-file $(pwd)/boilerplate.go.txt \</span><br><span class="line">  --output-base $(pwd)/../../</span><br></pre></td></tr></table></figure>
<p>在执行脚本过后, 它会在<code>types.go</code>旁生成deepcopy代码, 并会在我们指定的generated文件夹下生成informer, lister等代码.</p>
<h3 id="编写与调用Controller"><a href="#编写与调用Controller" class="headerlink" title="编写与调用Controller"></a>编写与调用Controller</h3><p>现在万事俱备只欠实现最后的自定义资源处理逻辑, 就是之前提到的controller.</p>
<p>首先我们需要定义controller的成员:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">type Controller struct &#123;</span><br><span class="line">	// kubeclientset is a standard kubernetes clientset</span><br><span class="line">	kubeclientset kubernetes.Interface</span><br><span class="line">	// beerclientset is a clientset for our own API group</span><br><span class="line">	beerclientset clientset.Interface</span><br><span class="line"></span><br><span class="line">	deploymentsLister appslisters.DeploymentLister</span><br><span class="line">	deploymentsSynced cache.InformerSynced</span><br><span class="line">	beersLister   listers.beerLister</span><br><span class="line">	beersSynced   cache.InformerSynced</span><br><span class="line"></span><br><span class="line">	// workqueue is a rate limited work queue. This is used to queue work to be</span><br><span class="line">	// processed instead of performing it as soon as a change happens. This</span><br><span class="line">	// means we can ensure we only process a fixed amount of resources at a</span><br><span class="line">	// time, and makes it easy to ensure we are never processing the same item</span><br><span class="line">	// simultaneously in two different workers.</span><br><span class="line">	workqueue workqueue.RateLimitingInterface</span><br><span class="line">	// recorder is an event recorder for recording Event resources to the</span><br><span class="line">	// Kubernetes API.</span><br><span class="line">	recorder record.EventRecorder</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中kubeclientset可以调用k8s的CRUD api, 例如创建更新deployment; beerclientset可以调用自定义资源的CRUD; deploymentsLister与beersLister可以通过namespace/name获得对应资源; workqueue用来同步与限流多个自定义资源处理worker; recorder用来publish在资源处理过程中的事件, 该事件可以在kubectl describe里面看到.</p>
<p>接着我们可以创建构造函数将clientset, informer传入构建自己的controller对象, 并通过informer的<code>AddEventHandler</code>添加监听, 将回调的beer资源通过indexer(cache)的MetaNamespaceKeyFunc方法转换为key, 加入workqueue队列.</p>
<p>当然有队列必然有死循环去读取这个队列, 这也是我们启动整个controller的入口, 我们需要从workqueue中pop交由下游处理, 在处理成功后调用forget方法清除queue, 否则会重新进行处理.</p>
<p>处理资源是我们controller的核心逻辑, 这里我们可以再次通过indexer(cache)通过key反转回namespace/name, 然后通过listers查找对应的资源, 比如beer或者deployment, 通过对比自定义资源与背后k8s资源的区别, 对k8s资源进行CRUD.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">func (c *Controller) syncHandler(key string) error &#123;</span><br><span class="line">	// Convert the namespace/name string into a distinct namespace and name</span><br><span class="line">	namespace, name, err := cache.SplitMetaNamespaceKey(key)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		utilruntime.HandleError(fmt.Errorf(&quot;invalid resource key: %s&quot;, key))</span><br><span class="line">		return nil</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Get the beer resource with this namespace/name</span><br><span class="line">	beer, err := c.beersLister.beers(namespace).Get(name)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		// The beer resource may no longer exist, in which case we stop</span><br><span class="line">		// processing.</span><br><span class="line">		klog.Infof(&quot;beer %s is deleted &quot;, name)</span><br><span class="line">		if errors.IsNotFound(err) &#123;</span><br><span class="line">			utilruntime.HandleError(fmt.Errorf(&quot;beer &apos;%s&apos; in work queue no longer exists&quot;, key))</span><br><span class="line">			return nil</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		return err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	deploymentName := beer.Spec.beerName</span><br><span class="line">	if deploymentName == &quot;&quot; &#123;</span><br><span class="line">		// We choose to absorb the error here as the worker would requeue the</span><br><span class="line">		// resource otherwise. Instead, the next time the resource is updated</span><br><span class="line">		// the resource will be queued again.</span><br><span class="line">		utilruntime.HandleError(fmt.Errorf(&quot;%s: deployment name must be specified&quot;, key))</span><br><span class="line">		return nil</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	deployment, err := c.deploymentsLister.Deployments(beer.Namespace).Get(beer.Name)</span><br><span class="line">	// If the resource doesn&apos;t exist, we&apos;ll create it</span><br><span class="line">	if errors.IsNotFound(err) &#123;</span><br><span class="line">		deployment, err = c.kubeclientset.AppsV1().Deployments(beer.Namespace).Create(context.TODO(), newDeployment(beer), metav1.CreateOptions&#123;&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// If an error occurs during Get/Create, we&apos;ll requeue the item so we can</span><br><span class="line">	// attempt processing again later. This could have been caused by a</span><br><span class="line">	// temporary network failure, or any other transient reason.</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		return err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  // ***********************</span><br><span class="line">  // Handle custom CRUD here</span><br><span class="line">  // ***********************</span><br><span class="line"></span><br><span class="line">	c.recorder.Event(beer, corev1.EventTypeNormal, SuccessSynced, MessageResourceSynced)</span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个<code>syncHanlder</code>函数分为四个部分:</p>
<ul>
<li>通过index做key-&gt;namespace/name</li>
<li>通过lister查找beer资源<ul>
<li>如果不存在, 说明这是一次删除操作, 直接返回</li>
</ul>
</li>
<li>通过lister获取deployment<ul>
<li>如果不存在, 通过beer中相关字段创建对应的deployment, 或者其他k8s资源</li>
</ul>
</li>
<li>否则, 说明资源已经存在, 则对比beer与实际资源的区别, 判断是否需要对相应的资源, 如deployment进行更新. 这里举例子</li>
</ul>
<p>当然在整个过程中也可以通过<code>recorder</code>来广播event, 这样在apply自定义资源后, 可以获取一定信息, 方便查看或者debug问题原因.</p>
<p>controller完整的逻辑存在大量boilerplate的代码, 具体也可以参考官方的<a href="https://github.com/kubernetes/sample-controller/blob/master/controller.go" target="_blank" rel="noopener">sample</a>进行学习.</p>
<p>最后还有一点需要注意的是, 在我们创建并启动自己的controller时, 即本次<code>custom-k8s-controller</code>的入口main package内, 除了调用构造以及启动函数, 一定要记得传入的Informer需要调用<code>Start</code>进行启动, 否则无法获得资源变化的回调. 当然这里也涉及到需要传入一个stopSignal可以让监听中断, 这一个可以直接cop<a href="https://github.com/kubernetes/sample-controller/tree/master/pkg/signals" target="_blank" rel="noopener">y官方代码</a>.</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>k8s已经提供了一个非常详尽的<a href="https://github.com/kubernetes/sample-controller" target="_blank" rel="noopener">demo</a>来实现自定义资源并通过controller进行配置, 但是对于没有go开发经验, 有不少由于版本, 依赖, 权限造成的小问题, 希望文章中highlight的点能提供一定帮助~</p>
<p>最后通过不懈努力, 我们可以通过一个自定义的Beer资源来deploy pod了. 由于这条路的打通, 我们可以继续添加CRD的schema, 并在controller内进行解析, 简化deploy过程, 统一基于k8s的微服务基础架构. 比如对于任意一个通过Beer资源deploy的app, 我们都通过istio sidecar来做ingress/outgress, 对于image的完整仓库地址, 我们也在后面通过不同部署(apply)环境来组合不同的地址, 还有大量缺省值的公共配置, 都不需要再重复的写在多个yaml中了.</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://github.com/kubernetes/sample-controller" target="_blank" rel="noopener">https://github.com/kubernetes/sample-controller</a></li>
<li><a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/</a></li>
<li><a href="https://itnext.io/comparing-kubernetes-api-extension-mechanisms-of-custom-resource-definition-and-aggregated-api-64f4ca6d0966" target="_blank" rel="noopener">https://itnext.io/comparing-kubernetes-api-extension-mechanisms-of-custom-resource-definition-and-aggregated-api-64f4ca6d0966</a></li>
</ul>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">标签</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/Istio/">Istio</a> <a class="tag tag--primary tag--small t-link" href="/tags/Kubernetes/">Kubernetes</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2021/06/28/Android-Framework-Points/"
                    data-tooltip="Android Framework知识总结"
                    aria-label="上一篇: Android Framework知识总结"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2020/10/27/Refresh-Clean-Code/"
                    data-tooltip="Refresh Clean Code"
                    aria-label="下一篇: Refresh Clean Code"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Diesen Beitrag teilen"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://talentprince.github.io/2020/12/14/Custom-your-own-k8s-resource/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=http://talentprince.github.io/2020/12/14/Custom-your-own-k8s-resource/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=http://talentprince.github.io/2020/12/14/Custom-your-own-k8s-resource/"
                    title="分享到 Google+"
                    aria-label="分享到 Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Nach oben">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2023 Prince Chen. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2021/06/28/Android-Framework-Points/"
                    data-tooltip="Android Framework知识总结"
                    aria-label="上一篇: Android Framework知识总结"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2020/10/27/Refresh-Clean-Code/"
                    data-tooltip="Refresh Clean Code"
                    aria-label="下一篇: Refresh Clean Code"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Diesen Beitrag teilen"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://talentprince.github.io/2020/12/14/Custom-your-own-k8s-resource/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=http://talentprince.github.io/2020/12/14/Custom-your-own-k8s-resource/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=http://talentprince.github.io/2020/12/14/Custom-your-own-k8s-resource/"
                    title="分享到 Google+"
                    aria-label="分享到 Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Nach oben">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="5">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=http://talentprince.github.io/2020/12/14/Custom-your-own-k8s-resource/"
                        aria-label="分享到 Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>分享到 Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=http://talentprince.github.io/2020/12/14/Custom-your-own-k8s-resource/"
                        aria-label="分享到 Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>分享到 Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://plus.google.com/share?url=http://talentprince.github.io/2020/12/14/Custom-your-own-k8s-resource/"
                        aria-label="分享到 Google+"
                    >
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>分享到 Google+</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <h4 id="about-card-name">Prince Chen</h4>
        
            <div id="about-card-bio"><p>Xidian B/M EE <br> 热爱生活, 关爱老婆 <br> 友情链接 <a href="https://www.cnblogs.com/mengdd/">圣骑士</a></p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Worker</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Xi&#39;an
            </div>
        
    </div>
</div>

        
            <div id="algolia-search-modal" class="modal-container">
    <div class="modal">
        <div class="modal-header">
            <span class="close-button"><i class="fa fa-times"></i></span>
            <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled">
                <span class="searchby-algolia-text text-color-light text-small">by</span>
                <img class="searchby-algolia-logo" src="/assets/images/logo-algolia-nebula-blue-full.svg">
            </a>
            <i class="search-icon fa fa-search"></i>
            <form id="algolia-search-form">
                <input type="text" id="algolia-search-input" name="search"
                    class="form-control input--large search-input" placeholder="Search "
                    />
            </form>
        </div>
        <div class="modal-body">
            <div class="no-result text-color-light text-center">没有找到文章</div>
            <div class="results">
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="http://talentprince.github.io/2014/12/15/2014-12-15-first-blog/"
                            aria-label=": First Blog"
                        >
                            <h3 class="media-heading">First Blog</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2014年12月15日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a
                            class="link-unstyled"
                            href="http://talentprince.github.io/2014/12/15/2014-12-15-robolectric-in-android-studio/"
                            aria-label=": Robolectric in Android Studio"
                        >
                            <img class="media-image" src="http://res.cloudinary.com/dtn0pkdmg/image/upload/v1506326188/robolectric_f8qftj.png" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="http://talentprince.github.io/2014/12/15/2014-12-15-robolectric-in-android-studio/"
                            aria-label=": Robolectric in Android Studio"
                        >
                            <h3 class="media-heading">Robolectric in Android Studio</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2014年12月15日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><h2 id="Robolectric"><a href="#Robolectric" class="headerlink" title="Robolectric"></a>Robolectric</h2><p>Robolectric is a unit test framework that de-fangs the Android SDK jar so you can test-drive the development of your Android app. Tests run inside the JVM on your workstation in seconds. With Robolectric you can write tests like this:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Test class for MyActivity @RunWith(RobolectricTestRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyActivityTest</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">  <span class="meta">@Test</span>   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clickingButton_shouldChangeResultsViewText</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  Activity activity = Robolectric.buildActivity(MyActivity.class).create().get();</span><br><span class="line">    Button pressMeButton = (Button) activity.findViewById(R.id.press_me_button);</span><br><span class="line">    TextView results = (TextView) activity.findViewById(R.id.results_text_view);</span><br><span class="line"></span><br><span class="line">    pressMeButton.performClick();</span><br><span class="line">    String resultsText = results.getText().toString();</span><br><span class="line">    assertThat(resultsText, equalTo(<span class="string">"Testing Android Rocks!"</span>));   &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>Robolectric makes this possible by rewriting Android SDK classes as they’re being loaded and making it possible for them to run on a regular JVM. </p>
<hr></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a
                            class="link-unstyled"
                            href="http://talentprince.github.io/2014/12/18/2014-12-18-activity-chang-yong-shu-xing-yu-launch-mode-zheng-jie/"
                            aria-label=": Activity LaunchMode 与 Intent Flags 揭秘"
                        >
                            <img class="media-image" src="http://res.cloudinary.com/dtn0pkdmg/image/upload/v1506326188/lunchmode_fvssls.jpg" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="http://talentprince.github.io/2014/12/18/2014-12-18-activity-chang-yong-shu-xing-yu-launch-mode-zheng-jie/"
                            aria-label=": Activity LaunchMode 与 Intent Flags 揭秘"
                        >
                            <h3 class="media-heading">Activity LaunchMode 与 Intent Flags 揭秘</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2014年12月18日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>Android Activity所涉及的四种Launch Mode与其重要的几个属性，如taskAffinity，allowTaskReparenting等，包括Intent内的各种Flag的功效，一直是为广大开发者所苦恼，网上文章众说纷纭，开发文档又及其模糊且与实际情况有一定偏差，那么今天我们就来真正的揭秘，还原事实的真相。<br></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a
                            class="link-unstyled"
                            href="http://talentprince.github.io/2014/12/23/2014-12-23-joda-time-zhong-ying-ge-shi-hua-xiang-guan-wen-ti/"
                            aria-label=": Joda Time 中英格式化相关问题 for Java"
                        >
                            <img class="media-image" src="http://res.cloudinary.com/dtn0pkdmg/image/upload/v1506326187/joda_e277de.png" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="http://talentprince.github.io/2014/12/23/2014-12-23-joda-time-zhong-ying-ge-shi-hua-xiang-guan-wen-ti/"
                            aria-label=": Joda Time 中英格式化相关问题 for Java"
                        >
                            <h3 class="media-heading">Joda Time 中英格式化相关问题 for Java</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2014年12月23日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><h1 id="Joda-Time"><a href="#Joda-Time" class="headerlink" title="Joda Time"></a>Joda Time</h1><p>Joda-Time提供了一组Java类包用于处理包括ISO8601标准在内的date和time。可以利用它把JDK Date和Calendar类完全替换掉，而且仍然能够提供很好的集成。  </p>
<h2 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h2><p>Joda已经更新到2.6版本,jar包的下载可以到<a href="https://github.com/JodaOrg/joda-time/releases/tag/v2.6" target="_blank" rel="noopener">Joda Jar</a>进行下载.<br>如果使用gradle管理,可添加 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    compile &apos;joda-time:joda-time:2.6&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a
                            class="link-unstyled"
                            href="http://talentprince.github.io/2015/01/04/2015-01-04-android-yu-inject-yi-lai-zhu-ru-de-bu-jie-zhi-yuan/"
                            aria-label=": Android 与Inject(依赖注入)的不解之缘"
                        >
                            <img class="media-image" src="http://res.cloudinary.com/dtn0pkdmg/image/upload/v1506326188/butterknife_g7rpiq.png" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="http://talentprince.github.io/2015/01/04/2015-01-04-android-yu-inject-yi-lai-zhu-ru-de-bu-jie-zhi-yuan/"
                            aria-label=": Android 与Inject(依赖注入)的不解之缘"
                        >
                            <h3 class="media-heading">Android 与Inject(依赖注入)的不解之缘</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年1月4日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p> 依赖注入(DI)<br> 有些人说Android使用依赖注入是因为很多J2EE的人带来的异域思想, 满天飞的<code>注解</code>让人莫不找头脑, 使简单的行为变得复杂, 表面简化, 实则复杂.</p>
<p> 但是在使用其一段时间后, 确实还是挺不错的. 正如其思想之精髓, 让你只关注<strong>结果</strong>,而忽略<strong>制作过程</strong>, 呵呵, 跟<code>周星驰</code>他老母恰巧相反.  </p>
<p> 那么下面就讲讲Android开发中常常的用的一些DI框架, 来简化亲们的开发流程吧.</p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a
                            class="link-unstyled"
                            href="http://talentprince.github.io/2015/01/07/2015-01-07-android-activity-quan-ping-fang-fa-zong-jie/"
                            aria-label=": Android Activity 全屏方法总结"
                        >
                            <img class="media-image" src="http://res.cloudinary.com/dtn0pkdmg/image/upload/v1506326189/fullscreen_lkruui.jpg" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="http://talentprince.github.io/2015/01/07/2015-01-07-android-activity-quan-ping-fang-fa-zong-jie/"
                            aria-label=": Android Activity 全屏方法总结"
                        >
                            <h3 class="media-heading">Android Activity 全屏方法总结</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年1月7日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>Android版本繁多, 新API, 新Flag层出不穷, 针对于如何完美全屏, 下面做以总结.</p>
<p>所有方法只涉及<strong>代码</strong>操作, 非xml修改Activity属性所致</p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a
                            class="link-unstyled"
                            href="http://talentprince.github.io/2015/01/26/2015-01-26-android-zhang-hao-yu-tong-bu-xi-tong-part-one/"
                            aria-label=": Android 构建账号与同步服务 Part One"
                        >
                            <img class="media-image" src="http://res.cloudinary.com/dtn0pkdmg/image/upload/v1506326189/sync1_sbvugj.png" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="http://talentprince.github.io/2015/01/26/2015-01-26-android-zhang-hao-yu-tong-bu-xi-tong-part-one/"
                            aria-label=": Android 构建账号与同步服务 Part One"
                        >
                            <h3 class="media-heading">Android 构建账号与同步服务 Part One</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年1月26日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><h4 id="账号与同步"><a href="#账号与同步" class="headerlink" title="账号与同步"></a>账号与同步</h4><p>Android从<code>API Level5</code>就有了自己的同步服务, 但很少有程序使用到, 一来大多数程序不需要所谓的同步,二来很多程序自己实现了后台的同步更新. 随着Android程序开发的逐渐程序, 越来越的的程序使用到了系统提供的服务来完成<code>账号认证</code>与<code>同步更新</code>, 我们可以打开系统设置–&gt;账号进行查看, 就能看到很多应用都这么做了. 这样做有两个好处, 一来系统服务做更新同步(<code>SyncAdapter</code>)唤醒更加绿色环保, 二来实现了账号认证(<code>Authenticator</code>)还可以为其他应用提供第三方认证服务, 如大家常见的使用QQ或者微博账号登录, 由于你手机上安装的QQ与微博实现了该接口, 便可以通过开发者账号获得授权Token来做第三方认证.</p>
<p>本期博客分三部分来讲, 通过一个小应用(Part Three提供源码)来概述所有相关内容, 大体章节如下</p>
<ul>
<li><p>数据模型建立与加载 (ContentProvider LoaderManager)</p>
</li>
<li><p>更新系统建立 (SyncAdapter)</p>
</li>
<li><p>账号系统建立 (Account Authenticator)</p>
</li>
</ul>
<p>下面先来讲讲如何轻松本地数据库并完成数据到界面的加载</p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a
                            class="link-unstyled"
                            href="http://talentprince.github.io/2015/02/04/2015-02-04-android-gou-jian-zhang-hao-yu-tong-bu-fu-wu-part-two/"
                            aria-label=": Android 构建账号与同步服务 Part Two"
                        >
                            <img class="media-image" src="http://res.cloudinary.com/dtn0pkdmg/image/upload/v1506326189/sync2_uyvihr.jpg" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="http://talentprince.github.io/2015/02/04/2015-02-04-android-gou-jian-zhang-hao-yu-tong-bu-fu-wu-part-two/"
                            aria-label=": Android 构建账号与同步服务 Part Two"
                        >
                            <h3 class="media-heading">Android 构建账号与同步服务 Part Two</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月4日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>紧接<a href="http://talentprince.github.io/blog/2015/01/26/android-zhang-hao-yu-tong-bu-xi-tong-part-one/">上一部分</a></p>
<h4 id="更新系统的建立"><a href="#更新系统的建立" class="headerlink" title="更新系统的建立"></a>更新系统的建立</h4><p>更新系统即是所说的<a href="http://developer.android.com/training/sync-adapters/creating-sync-adapter.html" target="_blank" rel="noopener">SyncAdapter</a>, 实现了这个系统服务, 就可以利用系统的定时器对程序数据<code>ContentProvider</code>进行更新, 也可以在系统设置-&gt;账号里面控制开启或者关闭(如果<code>SyncAdapter</code>的配置文件允许的话)</p>
<p>完成这些服务的布置大概有三步</p>
<ul>
<li>创建SyncService并提供SyncAdapter的IBinder接口以便让系统调用</li>
<li>声明Sync服务, 并制定SyncAdapter的配置文件</li>
<li>生成账户启动Sync</li>
</ul></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a
                            class="link-unstyled"
                            href="http://talentprince.github.io/2015/02/10/2015-02-10-android-gou-jian-zhang-hao-yu-tong-bu-fu-wu-part-three/"
                            aria-label=": Android 构建账号与同步服务 Part Three"
                        >
                            <img class="media-image" src="http://res.cloudinary.com/dtn0pkdmg/image/upload/v1506326189/sync3_trl1qb.jpg" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="http://talentprince.github.io/2015/02/10/2015-02-10-android-gou-jian-zhang-hao-yu-tong-bu-fu-wu-part-three/"
                            aria-label=": Android 构建账号与同步服务 Part Three"
                        >
                            <h3 class="media-heading">Android 构建账号与同步服务 Part Three</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月10日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><h4 id="紧接上期"><a href="#紧接上期" class="headerlink" title="紧接上期"></a>紧接<a href="http://talentprince.github.io/blog/2015/02/04/android-gou-jian-zhang-hao-yu-tong-bu-fu-wu-part-two/">上期</a></h4><h4 id="账号系统建立-Account-Authenticator"><a href="#账号系统建立-Account-Authenticator" class="headerlink" title="账号系统建立 Account Authenticator"></a>账号系统建立 Account Authenticator</h4><p>如果只需要借助系统更新服务(SyncAdapter)来做定期维护, 那么通过前两部分的介绍, 已经可以达到所预期的目标了.</p>
<p>本期话题将会解决</p>
<ul>
<li>添加账号</li>
<li>获得授权</li>
</ul>
<p>这些服务全部都是可以跨进程的操作, 完成了这些操作, 我们就可以完成像<code>QQ</code> <code>新浪微博</code> 一样的功能, 账号系统可以为第三方应用授权.</p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a
                            class="link-unstyled"
                            href="http://talentprince.github.io/2016/01/26/2016-01-26-qing-chu-yu-ming-bai/"
                            aria-label=": 清楚与明白"
                        >
                            <img class="media-image" src="http://res.cloudinary.com/dtn0pkdmg/image/upload/v1506326189/understand_fuwgh9.jpg" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="http://talentprince.github.io/2016/01/26/2016-01-26-qing-chu-yu-ming-bai/"
                            aria-label=": 清楚与明白"
                        >
                            <h3 class="media-heading">清楚与明白</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2016年1月26日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>许久未更新, 已渐渐落草, 回顾过去一年, checklist总归是完成为多, pending为少, 但这并不意味着很多事情都得到了清楚的解决, 也有很多事情可能还需要时间去琢磨才能想的明白.</p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
            </div>
        </div>
        <div class="modal-footer">
            <p class="results-count text-medium"
                data-message-zero="没有找到文章"
                data-message-one="找到 1 篇文章"
                data-message-other="找到 {n} 篇文章">
                找到 51 篇文章
            </p>
        </div>
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/new_cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-aps5gauztkpi1ygcutx4tgx00wcsooq0okdwjt46e3hduxfhmurq7md3aeoa.min.js"></script>
<!--SCRIPTS END-->


    



    <script src="/assets/js/moment-with-locales.js"></script>
    <script src="/assets/js/algoliasearch.js"></script>
    <script>
      var algoliaClient = algoliasearch('Z7A3XW4R2I', '12db1ad54372045549ef465881c17e743');
      var algoliaIndex = algoliaClient.initIndex('my-hexo-blog');
    </script>


    </body>
</html>
